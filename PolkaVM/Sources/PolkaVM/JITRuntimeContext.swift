// generated by polka.codes
// Swift wrapper for C++ RuntimeContext
// This provides type-safe access to JIT runtime functionality

import CppHelper
import Foundation

/// Swift wrapper for C++ RuntimeContext
/// Manages the lifecycle of a JIT runtime instance
/// Each instance has its own isolated C++ state for thread-safe concurrent execution
final class JITRuntimeContext {
    private let contextPtr: UnsafeMutableRawPointer

    /// Creates a new RuntimeContext
    init() {
        contextPtr = createRuntimeContext()
        if contextPtr == nil {
            fatalError("Failed to create RuntimeContext")
        }
    }

    /// Destroys the RuntimeContext and frees all associated resources
    deinit {
        destroyRuntimeContext(contextPtr)
    }

    /// Get the opaque context pointer for passing to C++ functions
    var contextPointer: UnsafeMutableRawPointer {
        contextPtr
    }

    /// Get dispatcher table for a compiled function
    /// - Parameter functionPtr: Compiled function pointer
    /// - Returns: Tuple of (dispatcher table pointer, size) or nil if not found
    func getDispatcherTable(for functionPtr: UnsafeRawPointer) -> (UnsafeMutablePointer<UnsafeMutableRawPointer?>?, Int)? {
        var size: size_t = 0
        guard let table = CppHelper.getDispatcherTable(contextPointer, UnsafeMutableRawPointer(mutating: functionPtr), &size), size > 0 else {
            return nil
        }
        return (table, Int(size))
    }

    /// Release JIT-compiled function
    /// - Parameter functionPtr: Function pointer to release
    func releaseFunction(functionPtr: UnsafeRawPointer) {
        CppHelper.releaseJITFunction(contextPointer, UnsafeMutableRawPointer(mutating: functionPtr))
    }

    /// Free dispatcher table for a function
    /// - Parameter functionPtr: Function pointer whose dispatcher table should be freed
    func freeDispatcherTable(for functionPtr: UnsafeRawPointer) {
        CppHelper.freeDispatcherTable(contextPointer, UnsafeMutableRawPointer(mutating: functionPtr))
    }

    /// Free all dispatcher tables
    /// Useful for cleanup or memory pressure situations
    func freeAllDispatcherTables() {
        CppHelper.freeAllDispatcherTables(contextPointer)
    }
}
