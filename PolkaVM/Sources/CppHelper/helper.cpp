// generated by polka.codes
#include "helper.hh"
#include "instruction_emitter.hh"
#include <stdio.h>
#include <cstring>

using namespace asmjit;

// Declare the extern C wrapper from instruction_dispatcher.cpp
extern "C" bool jit_emitter_emit_basic_block_instructions(
    void* _Nonnull assembler,
    const char* _Nonnull target_arch,
    const uint8_t* _Nonnull bytecode,
    uint32_t start_pc,
    uint32_t end_pc
);

// Trampoline for JIT code to call Swift host functions
// Called by JIT-generated code when executing ECALL instructions
uint32_t pvm_host_call_trampoline(
    JITHostFunctionTable* host_table,
    uint32_t host_call_index,
    uint64_t* guest_registers_ptr,
    uint8_t* guest_memory_base_ptr,
    uint32_t guest_memory_size,
    uint64_t* guest_gas_ptr) {

    if (!host_table || !host_table->dispatchHostCall) {
        // TODO: Implement proper error logging with error codes
        return 0xFFFFFFFF; // Error code for HostFunctionError (matches ExitReason.PanicReason)
    }

    // Dispatch to Swift implementation with invocationContext (passed implicitly through host_table)
    return host_table->dispatchHostCall(
        host_table->ownerContext,
        host_call_index,
        guest_registers_ptr,
        guest_memory_base_ptr,
        guest_memory_size,
        guest_gas_ptr,
        host_table->invocationContext
    );
}

// Compile a range of bytecode instructions to machine code
// This function bridges Swift's ProgramCode parsing with C++ instruction emission
bool compile_bytecode_range(
    void* _Nonnull assembler,
    const char* _Nonnull target_arch,
    const uint8_t* _Nonnull bytecode,
    size_t bytecode_size,
    uint32_t start_pc,
    uint32_t end_pc)
{
    // Validate inputs
    if (!assembler || !target_arch || !bytecode) {
        return false;
    }

    if (bytecode_size == 0 || start_pc >= end_pc) {
        return false;
    }

    if (end_pc > bytecode_size) {
        return false;
    }

    // Call the extern C wrapper to the instruction emitter
    // This function handles all 194 implemented instructions
    return jit_emitter_emit_basic_block_instructions(assembler, target_arch, bytecode, start_pc, end_pc);
}
