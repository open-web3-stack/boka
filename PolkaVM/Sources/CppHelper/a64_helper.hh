// generated by polka.codes
// AArch64-specific JIT compilation for PolkaVM

#pragma once

#include <cstdint>
#include <cstddef>

// - 0: Success
// - 1: Invalid input (null buffer or zero size)
// - 2: Invalid output parameter
// - Other: AsmJit error codes
//
// Function parameters (AArch64 ABI):
// - x0: registers_ptr (guest VM registers array)
// - x1: memory_base_ptr (guest VM memory)
// - w2: memory_size (guest VM memory size)
// - x3: gas_ptr (guest VM gas counter)
// - w4: initial_pvm_pc (starting program counter)
// - x5: invocation_context_ptr (JITHostFunctionTable)
//
// Static register allocation (AArch64):
// - x19: VM_REGISTERS_PTR - Guest VM registers array
// - x20: VM_MEMORY_PTR - Guest VM memory base
// - w21: VM_MEMORY_SIZE - Guest VM memory size
// - x22: VM_GAS_PTR - Guest VM gas counter
// - w23: VM_PC - Guest VM program counter
// - x24: VM_CONTEXT_PTR - Invocation context pointer
// - x9-x15: Temporary registers for computation
// - x0-x7: Parameter passing for function calls
// - x0: Return value register

// Label-based compilation with direct jumps for maximum performance
// Uses single-pass compilation with lazy label creation
// Same interface as compilePolkaVMCode_a64 but uses labels for control flow
//
// NEW: skipTable provides instruction sizes from Swift's ProgramCode.skip(pc)
// This is required for variable-length encoded instructions (LoadImmJump, BranchImm, etc.)
// skipTable[pc] = number of additional bytes after opcode (instruction size = skip + 1)
// NEW: bitmask provides instruction boundary markers for branch validation
// bitmask[pc/8] has bit 0 set if pc is an instruction boundary (per spec pvm.tex)
extern "C" int32_t compilePolkaVMCode_a64_labeled(
    void* _Nonnull context,      // NEW: Swift-owned runtime context
    const uint8_t* _Nonnull codeBuffer,
    size_t codeSize,
    uint32_t initialPC,
    uint32_t jitMemorySize,
    const uint32_t* _Nullable skipTable,   // instruction skip values
    size_t skipTableSize,                   // skip table size
    const uint8_t* _Nullable bitmask,      // bitmask for instruction boundaries
    size_t bitmaskSize,                    // bitmask size
    void* _Nullable * _Nonnull funcOut);

