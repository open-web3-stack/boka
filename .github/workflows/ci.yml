name: CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: Swift Lint
    runs-on: [self-hosted, linux]

    steps:
    - uses: actions/checkout@v4
    - name: Check swift codestyle
      uses: norio-nomura/action-swiftlint@3.2.1
      with:
        args: lint --config .swiftlint.yml --strict

  test:
    name: Build and Test
    runs-on: [self-hosted, linux]

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    - name: Cache SPM
      uses: actions/cache@v4
      with:
        path: '**/.build'
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
    - name: Cache static lib files
      uses: actions/cache@v4
      with:
        path: .lib
        key: ${{ runner.os }}-libs-${{ hashFiles('.lib/*.a') }}
        restore-keys: |
            ${{ runner.os }}-libs-
    - name: Setup Swift
      uses: SwiftyLab/setup-swift@latest
      with:
        swift-version: '6.0'
        development: true
    - name: Build
      run: make build
    - name: Test
      run: make test
