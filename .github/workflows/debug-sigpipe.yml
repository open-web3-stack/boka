name: Debug SIGPIPE

on:
  workflow_dispatch:
  push:
    branches: ["jit"]
    paths:
      - '.github/workflows/debug-sigpipe.yml'
      - 'PolkaVM/Sources/Sandbox/main.swift'
      - 'PolkaVM/Sources/PolkaVM/Executors/ChildProcessManager.swift'

jobs:
  debug:
    name: Debug SIGPIPE Issue
    runs-on: [self-hosted, linux]
    timeout-minutes: 30
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Swift
      uses: SwiftyLab/setup-swift@latest

    - name: Check Sandbox Binary
      run: |
        echo "=== Checking sandbox binary ==="
        swift build --package-path PolkaVM --target Sandbox

        echo "=== Checking for blockSIGPIPE in binary ==="
        nm PolkaVM/.build/x86_64-unknown-linux-gnu/release/boka-sandbox 2>/dev/null | grep -i sigpipe || echo "No SIGPIPE symbols found"

        echo "=== Checking sandbox main.swift content ==="
        head -80 PolkaVM/Sources/Sandbox/main.swift | grep -A 5 "blockSIGPIPE\|SIGPIPE"

    - name: Test 1: Minimal Sandbox Test
      run: |
        echo "=== Test 1: Minimal PolkaVM test ==="
        swift test --package-path PolkaVM --enable-test-discovery --filter jitHaltParity 2>&1 | tail -20

    - name: Test 2: Single Sandbox Worker Test
      run: |
        echo "=== Test 2: Test with single worker ==="
        swift test --package-path PolkaVM --enable-test-discovery --filter "jitStoreU16Parity\|jitLoadStore" 2>&1 | tail -30

    - name: Test 3: PVM Tests (Small Subset)
      run: |
        echo "=== Test 3: Small PVM program test ==="
        cd PolkaVM
        swift test --enable-test-discovery -c release --filter "pVM(testCase:)" 2>&1 | grep -E "Passing|passed|failed|error" | head -50

    - name: Test 4: Check ChildProcessManager SIGPIPE Block
      run: |
        echo "=== Test 4: Verify child SIGPIPE blocking ==="
        grep -A 10 "Block SIGPIPE in child" PolkaVM/Sources/PolkaVM/Executors/ChildProcessManager.swift || echo "SIGPIPE block NOT found in child process"

    - name: Test 5: Run JAMTests Tiny Subset
      run: |
        echo "=== Test 5: JAMTests tiny subset ==="
        swift test --package-path JAMTests --enable-test-discovery -c release --filter "tinyTests" 2>&1 | tail -30

    - name: Collect Debug Info
      if: always()
      run: |
        echo "=== Collecting system information ==="
        echo "Swift version:"
        swift --version
        echo ""
        echo "System info:"
        uname -a
        echo ""
        echo "Process limits:"
        ulimit -a
